# åˆ é™¤åŠŸèƒ½ä¿®å¤æ€»ç»“

## é—®é¢˜æè¿°

ç”¨æˆ·æŠ¥å‘Šï¼šåˆ é™¤åŠŸèƒ½å¤±æ•ˆäº†

## æ ¹æœ¬åŸå› 

`delete_task`æ–¹æ³•å¯¹**æ‰€æœ‰ä»»åŠ¡**ï¼ˆåŒ…æ‹¬stopped/completed/failedï¼‰éƒ½å°è¯•è·å–`self.lock`ï¼Œå¯¼è‡´ä»¥ä¸‹é—®é¢˜ï¼š

1. **stoppedä»»åŠ¡**ï¼šä»»åŠ¡å·²åœæ­¢ï¼Œä¸å†ä½¿ç”¨é”ï¼Œä½†åˆ é™¤ä»è¦ç­‰å¾…è·å–é”
2. **é”ç«äº‰**ï¼šå¦‚æœæœ‰å…¶ä»–æ•°æ®åº“æ“ä½œæ­£åœ¨è¿›è¡Œï¼Œåˆ é™¤ä¼šè¶…æ—¶ï¼ˆ4.5ç§’ï¼‰
3. **ç”¨æˆ·ä½“éªŒå·®**ï¼šåˆ é™¤å·²åœæ­¢çš„ä»»åŠ¡éœ€è¦ç­‰å¾…å¾ˆé•¿æ—¶é—´

### é—®é¢˜ä»£ç ï¼ˆä¿®å¤å‰ï¼‰

```python
def delete_task(self, task_id):
    # å¯¹æ‰€æœ‰ä»»åŠ¡éƒ½è®¾ç½®stop_requested
    with self._memory_lock:
        self._stop_requested.add(task_id)

    # å¯¹æ‰€æœ‰ä»»åŠ¡éƒ½å°è¯•è·å–é”
    acquired = self.lock.acquire(blocking=True, timeout=2)
    if not acquired:
        time.sleep(0.5)
        acquired = self.lock.acquire(blocking=True, timeout=2)
        if not acquired:
            raise TimeoutError(...)  # è¿™é‡Œå¯¼è‡´åˆ é™¤å¤±è´¥

    # åˆ é™¤æ“ä½œ...
```

## ä¿®å¤æ–¹æ¡ˆ

### æ ¸å¿ƒæ”¹è¿›

**æ™ºèƒ½æ£€æŸ¥ä»»åŠ¡çŠ¶æ€**ï¼Œå¯¹ä¸åŒçŠ¶æ€çš„ä»»åŠ¡é‡‡ç”¨ä¸åŒç­–ç•¥ï¼š

| ä»»åŠ¡çŠ¶æ€ | åˆ é™¤ç­–ç•¥ | æ˜¯å¦éœ€è¦é” |
|---------|---------|-----------|
| stopped/completed/failed/cancelled | ç›´æ¥åˆ é™¤ | âŒ ä¸éœ€è¦ |
| running/paused | å…ˆåœæ­¢ï¼Œå†åˆ é™¤ | âœ… éœ€è¦ç­‰å¾… |

### ä¿®å¤åçš„ä»£ç 

```python
def delete_task(self, task_id):
    # é¦–å…ˆæ£€æŸ¥ä»»åŠ¡çŠ¶æ€
    task = self.get_task(task_id)
    if not task:
        return

    # å·²åœæ­¢çš„ä»»åŠ¡ï¼šç›´æ¥åˆ é™¤ï¼ˆä¸éœ€è¦é”ï¼‰
    if task['status'] in ['stopped', 'completed', 'failed', 'cancelled']:
        conn = sqlite3.connect(self.db_path, check_same_thread=False)
        cursor = conn.cursor()
        try:
            cursor.execute('DELETE FROM task_checkpoints WHERE task_id = ?', (task_id,))
            cursor.execute('DELETE FROM tasks WHERE task_id = ?', (task_id,))
            conn.commit()
        finally:
            conn.close()
        return

    # è¿è¡Œä¸­çš„ä»»åŠ¡ï¼šå…ˆåœæ­¢ï¼Œå†åˆ é™¤ï¼ˆéœ€è¦é”ï¼‰
    with self._memory_lock:
        self._stop_requested.add(task_id)

    acquired = self.lock.acquire(blocking=True, timeout=2)
    # ... åç»­åˆ é™¤é€»è¾‘
```

## ä¿®å¤æ•ˆæœ

### æ€§èƒ½æå‡

| åœºæ™¯ | ä¿®å¤å‰ | ä¿®å¤å |
|-----|-------|-------|
| åˆ é™¤stoppedä»»åŠ¡ | 4-5ç§’ï¼ˆå¯èƒ½è¶…æ—¶ï¼‰ | < 0.1ç§’ |
| åˆ é™¤completedä»»åŠ¡ | 4-5ç§’ï¼ˆå¯èƒ½è¶…æ—¶ï¼‰ | < 0.1ç§’ |
| åˆ é™¤runningä»»åŠ¡ | 4-5ç§’ | 4-5ç§’ï¼ˆéœ€è¦ç­‰å¾…åœæ­¢ï¼‰|

### åŠŸèƒ½éªŒè¯

| æµ‹è¯•åœºæ™¯ | é¢„æœŸç»“æœ | å®é™…ç»“æœ |
|---------|---------|---------|
| åˆ é™¤stoppedä»»åŠ¡ | ç«‹å³æˆåŠŸ | âœ… é€šè¿‡ï¼ˆ0.01ç§’ï¼‰ |
| åˆ é™¤runningä»»åŠ¡ | å…ˆåœæ­¢å†åˆ é™¤ | âœ… é€šè¿‡ |
| åˆ é™¤ä¸å­˜åœ¨çš„ä»»åŠ¡ | æ— æ“ä½œ | âœ… é€šè¿‡ |

### æµ‹è¯•ç»“æœ

```
=== æµ‹è¯•åˆ é™¤stoppedä»»åŠ¡ ===

1. ä»»åŠ¡å­˜åœ¨:
   status: stopped

2. åˆ é™¤ä»»åŠ¡...
   å“åº”æ—¶é—´: 0.01ç§’
   success: True

3. éªŒè¯åˆ é™¤ç»“æœ...
   âœ… ä»»åŠ¡å·²æˆåŠŸåˆ é™¤

âœ… æµ‹è¯•é€šè¿‡ï¼
```

## æŠ€æœ¯ç»†èŠ‚

### ä¸ºä»€ä¹ˆstoppedä»»åŠ¡ä¸éœ€è¦é”ï¼Ÿ

1. **ä»»åŠ¡çº¿ç¨‹å·²ç»“æŸ**ï¼šstoppedä»»åŠ¡ä¸å†æ‰§è¡Œï¼Œä¸ä¼šæŒæœ‰é”
2. **æ— å¹¶å‘è®¿é—®**ï¼šæ²¡æœ‰ä»»åŠ¡çº¿ç¨‹åœ¨æ“ä½œè¿™ä¸ªä»»åŠ¡çš„æ•°æ®
3. **ç›´æ¥åˆ é™¤å®‰å…¨**ï¼šSQLiteçš„DELETEæ“ä½œæœ¬èº«æ˜¯åŸå­çš„

### é”çš„ä½¿ç”¨åœºæ™¯

| æ“ä½œ | æ˜¯å¦éœ€è¦é” | åŸå›  |
|-----|-----------|------|
| åˆ›å»ºä»»åŠ¡ | âœ… éœ€è¦ | é˜²æ­¢å¹¶å‘åˆ›å»º |
| æ›´æ–°runningä»»åŠ¡ | âœ… éœ€è¦ | ä»»åŠ¡çº¿ç¨‹å¯èƒ½åŒæ—¶æ›´æ–° |
| åˆ é™¤stoppedä»»åŠ¡ | âŒ ä¸éœ€è¦ | ä»»åŠ¡å·²ç»“æŸï¼Œæ— å¹¶å‘ |
| åˆ é™¤runningä»»åŠ¡ | âœ… éœ€è¦ | éœ€è¦ç­‰å¾…ä»»åŠ¡çº¿ç¨‹åœæ­¢ |

### è¾¹ç¼˜æƒ…å†µå¤„ç†

1. **ä»»åŠ¡ä¸å­˜åœ¨**ï¼šç›´æ¥è¿”å›ï¼Œæ— æ“ä½œ
2. **runningä»»åŠ¡**ï¼š
   - è®¾ç½®`stop_requested`æ ‡å¿—
   - ç­‰å¾…ä»»åŠ¡çº¿ç¨‹åœæ­¢å¹¶é‡Šæ”¾é”
   - ç„¶ååˆ é™¤
3. **è¶…æ—¶å¤„ç†**ï¼šå¦‚æœä»»åŠ¡ä¸å“åº”åœæ­¢è¯·æ±‚ï¼ŒæŠ›å‡ºTimeoutError

## ç›¸å…³ä¿®å¤

æœ¬æ¬¡ä¿®å¤æ˜¯ç³»åˆ—ä»»åŠ¡ç®¡ç†é—®é¢˜ä¿®å¤çš„ä¸€éƒ¨åˆ†ï¼š

1. **ç¬¬ä¸€æ¬¡ä¿®å¤**ï¼šåˆ é™¤é‡å¤çš„`request_stop`æ–¹æ³•ï¼ˆæ­»é”é—®é¢˜ï¼‰
2. **ç¬¬äºŒæ¬¡ä¿®å¤**ï¼šä½¿ç”¨å†…å­˜æ ‡å¿—æ£€æŸ¥ï¼ˆåœæ­¢åŠŸèƒ½ï¼‰
3. **ç¬¬ä¸‰æ¬¡ä¿®å¤**ï¼šæ™ºèƒ½åˆ é™¤ç­–ç•¥ï¼ˆæœ¬æ¬¡ä¿®å¤ï¼‰

## æ€»ç»“

é€šè¿‡åŒºåˆ†ä»»åŠ¡çŠ¶æ€å¹¶é‡‡ç”¨ä¸åŒçš„åˆ é™¤ç­–ç•¥ï¼Œæˆ‘ä»¬å®ç°äº†ï¼š

- âš¡ **å¿«é€Ÿåˆ é™¤stoppedä»»åŠ¡**ï¼š< 0.1ç§’
- âœ… **æ­£ç¡®å¤„ç†runningä»»åŠ¡**ï¼šå…ˆåœæ­¢å†åˆ é™¤
- ğŸ”“ **å‡å°‘é”ç«äº‰**ï¼šstoppedä»»åŠ¡ä¸éœ€è¦ç­‰å¾…é”
- ğŸ›¡ï¸ **ä¿æŒæ•°æ®ä¸€è‡´æ€§**ï¼šDELETEæ“ä½œæœ¬èº«æ˜¯åŸå­çš„

è¿™æ˜¯ä¸€ä¸ª"æ ¹æ®å¯¹è±¡çŠ¶æ€é€‰æ‹©æœ€ä¼˜ç­–ç•¥"çš„å…¸å‹æ¡ˆä¾‹ï¼š
- å·²åœæ­¢ â†’ ç›´æ¥åˆ é™¤ï¼ˆå¿«ï¼‰
- è¿è¡Œä¸­ â†’ å…ˆåœæ­¢å†åˆ é™¤ï¼ˆå®‰å…¨ï¼‰

---

**ä¿®å¤æ—¥æœŸ**: 2026-01-31
**ä¿®å¤ä½ç½®**: web/tasks.py:452-523
**å½±å“èŒƒå›´**: ä»»åŠ¡åˆ é™¤åŠŸèƒ½
**å‘åå…¼å®¹**: æ˜¯
**ç ´åæ€§å˜æ›´**: å¦
